<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=, initial-scale=">
    <title>Brass Fingerings</title>
    <script src="./Brass.js"></script>
    <script>var fingers = [false, false, false], horn=false;</script>
</head>
<body>

    <h1 class="title"><span id="instName">Brass</span> Fingerings</h1>
    <select onchange="instSelection()" id="instSelect">
        <option value="null"></option>
        <option value="trumpet">Trumpet</option>
        <option value="horn">Horn</option>
        <option value="trombone">Trombone</option>
        <option value="baritone">Baritone</option>
        <option value="tuba">Tuba</option>
    </select>
    <h1 id="noteName"></h1>
    <h2 id="isCorrect"></h2>

    <svg width="800" height="200" xmlns="http://www.w3.org/2000/svg">
        <g id="circles" stroke-width="3" fill="white">
            <ellipse stroke="black" id="r0" cx="50" cy="100" rx="40" ry="80" />
            <ellipse stroke="black" id="r1" cx="150" cy="100" rx="40" ry="40" />
            <ellipse stroke="black" id="r2" cx="250" cy="100" rx="40" ry="40" />
            <ellipse stroke="black" id="r3" cx="350" cy="100" rx="40" ry="40" />
        </g>
        <!-- <g id="trbCircles" style="display: none" stroke-width="3" fill="white">
            <circle id="p1" stroke="black" cy="100" r="40" cx="50"></circle>
            <circle id="p2" stroke="black" cy="100" r="40" cx="150"></circle>
            <circle id="p3" stroke="black" cy="100" r="40" cx="250"></circle>
            <circle id="p4" stroke="black" cy="100" r="40" cx="350"></circle>
            <circle id="p5" stroke="black" cy="100" r="40" cx="450"></circle>
            <circle id="p6" stroke="black" cy="100" r="40" cx="550"></circle>
            <circle id="p7" stroke="black" cy="100" r="40" cx="650"></circle>
        </g> -->
     </svg>

     <h1 id="test"></h1>
     <button onclick="showBinary()">Show Binary</button>
     <button onclick="newNote()">New Note</button>
     <button onclick="checkNote()">Check Note</button>
     <button onclick="showCorrectNote()">Show Note</button>


     <script>

        // TODO: Refactor all JS code to separate file

         var inst, instValue;

         function instSelection() {
            instValue = document.getElementById("instSelect").value;
            inst = BRASS[instValue];
            document.getElementById("instName").innerHTML = inst.getName();
            hornHide(instValue != "horn");
            reset();
         }

        function hornHide(isHidden) {
            let circles = document.getElementById("circles").children;
            for (let i=0; i<circles.length; i++) {
                let circle = circles[i];
                circle.attributes.cx.value = 50 - (100*isHidden) + i*100;
                console.log(50-100*isHidden);
            }
        }
        
        var currentNote;

        // Fingering Action
        let circles = document.getElementById("circles").children;
        for (let i = 0; i < circles.length; i++) {
            let circle = circles[i];
            let defaultColor = () => {
                if (fingers[i]) circle.style.fill = "#222222";
                if (!fingers[i]) circle.style.fill = "white";
            }

            circle.addEventListener("mouseover", () => {
                circle.style.fill = "#787878";
            });
            circle.addEventListener("mouseout", () => {
                defaultColor();
            })

            circle.addEventListener("click", c => {
                fingers[i] = !fingers[i];
                defaultColor();
                });
        }

         function toBinary(list) {
             let a = list.reduce((total, current, i) => total + current * Math.pow(2, i));
             return a.toString(2).split("").reverse().join("").padEnd(4, "0");
         }

         function showBinary() {
            document.getElementById("test").innerHTML = toBinary(fingers);
         }
         

         function newNote() {
            reset();
            let max = 12;
            let rand = Math.floor(Math.random() * max);
            let brassFingers = inst.fingerSet;
            let note = Object.keys(brassFingers)[rand];
            currentNote = [note, brassFingers[note]];
            
            console.log(currentNote);

            document.getElementById("noteName").innerHTML = currentNote[0].replace("S", "#");
         }

         function reset() {
             document.getElementById("noteName").innerHTML = "";
             document.getElementById("isCorrect").innerHTML = "";
             fingers = [false,false,false]
             for (let i = 0; i < circles.length; i++) {
                 circles[i].style.fill = "white";
                 circles[i].setAttribute("stroke", "black");
             }
             
         }

         function checkNote() {
            let note = currentNote[1], ans = parseInt(toBinary(fingers), 2), ansText = document.getElementById("isCorrect");
            if (note == ans) ansText.innerHTML = "YES!!!";
            else ansText.innerHTML = "no.";
         }

         function showCorrectNote() {
             let note = currentNote[1].toString(2).padStart(4, "0");
             console.log(note, note.length);
             for (let i = 0; i < note.length; i++) {
                 console.log(circles[i]);
                 if (parseInt(note[i], 2) == 1) circles[i].setAttribute("stroke", "red");
             }
         }

    </script>
</body>
</html>